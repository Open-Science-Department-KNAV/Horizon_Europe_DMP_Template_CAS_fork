{%- set contributorsPath = [uuids.adminDetailsCUuid, uuids.contributorsQUuid]|join(".") -%}
{%- set contributorsItems = repliesMap[contributorsPath]|reply_items -%}
<div id="dmp-contributors">
  <h2>Contributors</h2>

  <p>The following contributors are related to the {{globals.projects}} of this DMP:</p>
  {%- macro renderAnswerValue(question, reply, path, humanIdentifier) -%}
  <div>
    <p>
          {% if reply is of_type("StringReply") %}
        <span>{{reply.value}}</span>
      {% else %}
        <span>{{reply.value.rsplit(" ![]")[0]|markdown}}</span>
        {% if reply.is_integration %}
          {# Integration #}
          {% set integration = question.integration %}
          <span>
            ({{ integration.name }}: <a href="{{ integration.item(reply.item_id) }}">{{ reply.item_id }}</a>)
          </span>
        {% endif %}
      {% endif %}
    </p>
  </div>
{%- endmacro -%}

{# -------new code for CAS fork---------------#}
{% set contributors = [] %}
  {%- for contributor in contributorsItems -%}
   {%- set pathPrefix = [contributorsPath, contributor]|reply_path ~ "." -%}
    {%- set contributorName = repliesMap[pathPrefix ~ uuids.contributorNameQUuid] -%}
    {%- set contributorEmail = repliesMap[pathPrefix ~ uuids.contributorEmailQUuid]|reply_str_value -%}
    {%- set contributorOrcid = repliesMap[pathPrefix ~ uuids.contributorOrcidQUuid] -%}
    {%- set contributorRoles = repliesMap[pathPrefix ~ uuids.contributorRoleQUuid]|reply_items -%}
    {%- set contributorAffiliationReply = repliesMap[pathPrefix ~ uuids.contributorAffiliationQUuid] -%}
    {%- if contributorName -%}
      {%- set roles = [] -%}
      {%- for role in contributorRoles -%}
        {%- if role in dc.e.choices.keys() -%}
          {%- do roles.append(dc.e.choices[role].label) -%}
        {%- endif -%}
      {%- endfor -%}
      {%- do contributors.append({
        'name': contributorName,
        'affiliation': contributorAffiliationReply,
        'orcid': contributorOrcid,
        'email': contributorEmail,
        'roles': roles|sort, 
      }) -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if contributors|length > 0 -%}
 
  <ul>
  {% for contributor in contributors %}
   <li>
     <b> {{ macros.integrationCAS(contributor.name) }} </b>
      {%- if contributor.affiliation %}
       {{ macros.integrationFairSharing(contributor.affiliation) }}
      {%- endif %}
       {%- if contributor.email and contributor.orcid %}
        <br>{{ macros.formatEmail(contributor.email) }}, {{ macros.formatOrcid(contributor.orcid) }}
      {%- elif contributor.email %}
        <br>{{ macros.formatEmail(contributor.email) }}
      {%- elif contributor.orcid %}
        <br>{{ macros.formatOrcid(contributor.orcid) }}
      {%- endif -%}
      
      {%- if contributor.roles|length > 0 %} 
        {% if contributor.roles|length == 1 %}Role{% else %}Roles{% endif %}: {% for role in contributor.roles %}<span class="role">{{ role }}</span>
         {% if not loop.last %}, {% endif %}{% endfor %}
      {%- endif %}
      
    </li> <br> <br>
  {% endfor %}
  </ul> 
  
{%- elif dc.qtn.created_by -%}
  <ul>
    <li class="contributor">
      <span class="name">{{ dc.qtn.created_by.first_name }} {{ dc.qtn.created_by.last_name }}</span>
      <br>{{ macros.formatEmail(dc.qtn.created_by.email) }}
      {%- if dc.qtn.created_by.affiliation %}
      <br>Affiliation: <span class="affiliation">{{ dc.qtn.created_by.affiliation }}</span>
      {%- endif %}
    </li>
  </ul>
  {%- else -%}
  <div style="font-style:italic;">There are no contributors described for this DMP.</div>
  {%- endif -%}
</div>